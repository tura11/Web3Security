// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;


import {HandlerStatefulFuzzCatches} from "../../../src/invariant-break/HandlerStatefulFuzzCatches.sol";
import {Test} from "forge-std/Test.sol";
import {StdInvariant} from "forge-std/StdInvariant.sol";
import {MockUSDC} from "../../mocks/MockUSDC.sol";
import {MockWETH} from "../../mocks/MockWETH.sol";
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import {Handler} from "./Handler.t.sol";

contract Invariant is StdInvariant, Test {
    HandlerStatefulFuzzCatches state;
    MockUSDC usdc;
    MockWETH weth;
    Handler  handler;
    IERC20[] tokens;
    address user = makeAddr("user");
    uint256 startingAmount;


    function setUp() public {
        vm.startPrank(user);
        usdc = new MockUSDC();
        weth = new MockWETH();
        startingAmount = 1000; 
        usdc.mint(user, startingAmount);
        weth.mint(user, startingAmount);

        vm.stopPrank();
        tokens.push(usdc);
        tokens.push(weth);
        state = new HandlerStatefulFuzzCatches(tokens);
        // targetContract(address(state));
        handler = new Handler(state, usdc, weth, user);
        bytes4[] memory selectors = new bytes4[](4);
        selectors[0] = handler.depositUSDC.selector;
        selectors[1] = handler.depositWETH.selector;
        selectors[2] = handler.withdrawUSDC.selector;
        selectors[3] = handler.withdrawWETH.selector;
        targetSelector(FuzzSelector({addr: address(handler), selectors: selectors}));
        targetContract(address(handler));
    } 

    function invariant_UserCanWithdrawAlwaysTheExactAmount() public  {
        vm.startPrank(user);
        state.withdrawToken(usdc);
        state.withdrawToken(weth);
        vm.stopPrank();

        assert(usdc.balanceOf(address(state)) == 0);
        assert(weth.balanceOf(address(state)) == 0);

        assert(usdc.balanceOf(user) == startingAmount);
        assert(weth.balanceOf(user) == startingAmount);

    }
}
